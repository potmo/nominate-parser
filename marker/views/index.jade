doctype html
html
  head
    title=page.name
  script var page = !{JSON.stringify(page)}
  script var book = !{JSON.stringify(book)}
  body
    div.
        <b>#{book.start_year}-#{book.end_year}</b> #{book.book}#{book.book_letter}-#{book.book_number_type} <i>#{book.house} house</i>
        <br>session: #{book.sessiontype}

    div
        | book type: 
        input(type="radio", name="type_filter", value="0", checked=book.type=="unknown")
        | unknown 
        input(type="radio", name="type_filter", value="0", checked=book.type=="grid")
        | grid 
        input(type="radio", name="type_filter", value="0", checked=book.type=="handwritten")
        | handwritten 

    div.
        <br>Yes: #{page.votes.total.yes}
        <br>No: #{page.votes.total.no}
        <br>Refrain: #{page.votes.total.refrain}
        <br>Absent: #{page.votes.total.absent}
        <br>Missing: #{page.votes.total.missing}

    div.
        <br>page: #{page.page}/#{book.total_pages}
        <br>status: #{page.status}
    div.
        <a href="/pageeditor/!{page.id - page.page + 1}">first</a>
        <a href="/pageeditor/!{page.id - 1}">previous</a>
        <a href="/pageeditor/!{page.id + 1}">next</a>
        <a href="/pageeditor/!{page.id - page.page + book.total_pages}">last</a>
    script.
        document.onkeydown = function(evt) {
            evt = evt || window.event;
            switch(evt.keyCode){
                case 37: // left
                    window.location.href = "/pageeditor/" + (page.id - 1);
                    break;
                case 39: // right
                    window.location.href = "/pageeditor/" + (page.id + 1);
                    break;
                case 13: // enter
                    readPage();
                    break;
            }
        };
    div.
        <a href="/pageeditor/!{page.id - page.page}">previous book</a> <a href="/pageeditor/!{page.id + book.total_pages - page.page + 1}">next book</a>
    div.
        <input type="button" value="Save" onclick="readPage()"/>

    div.
        <div id="imagecontainer" style="max-width: 1000px; max-height: 1000px; position: relative;">
            <img id="originalimage" src="../image/#{page.image}" style="position: absolute; width: 100%; height: auto;" onload="onLoaded()"/>
            <canvas id="gridcanvas" style="position: relative; width: 100%; height: auto;">
        </div>
        <div id="resolvedcontainer" style="max-width: 1000px; max-height: 1000px; position: relative;">
            <img id="resolvedimage" src="../image/resolved/#{page.image}" style="width: 100%; height: auto;"/>
        </div>

        <script>
            console.log('page: %o', page);
            console.log('book: %o', book);

            var selectedHandle = null;
            var handles = [];
            var canvas;
            var context;

            var image = document.getElementById("originalimage");
            var canvas = document.getElementById("gridcanvas");

            var move = 0;
            var verticalRatios = [move+=.097, move+=.097, move+=.097, move+=.097, move+=.097, move+=.031, move+=.097, move+=.097, move+=.097, move+=.097];
            var horizontalRatios = Array(23).fill(1/24 - 0.0003).map(function(item, index){ return item * (index + 1) });

            document.getElementById('imagecontainer').appendChild(image);

            function onLoaded(){

                document.getElementById('imagecontainer').appendChild(canvas);
                canvas.width = image.width;
                canvas.height = image.height;

                context = canvas.getContext('2d');
                context.strokeStyle = 'rgba(255,0,0,1.0)';
                context.fillStyle = 'rgba(255,0,0,0.2)';

                handles = page.coordinates.map(function(coordinate, index){
                    return {radius: 10,
                            x: coordinate.x * canvas.width,
                            y: coordinate.y * canvas.height,
                            index: index};
                });


                canvas.addEventListener('mousedown', function(event){
                    var mouse = {x: event.offsetX, y: event.offsetY};

                    selectedHandle = handles
                        .concat()
                        //.filter(function(handle){
                        //    return dist(mouse, handle) < handle.radius;
                        //})
                        .sort(function(a,b){
                            return dist(mouse,b) - dist(mouse, a);
                        })
                        .pop();
                });

                canvas.addEventListener('mouseup', function(){
                    selectedHandle = null;
                });

                canvas.addEventListener('mousemove', function(event){
                    var mouse = {x: event.offsetX, y: event.offsetY};
                    if (selectedHandle) {
                        selectedHandle.x = mouse.x;
                        selectedHandle.y = mouse.y;
                    }
                });

                window.requestAnimationFrame(step);
            }


            function step(timestamp){
                context.clearRect(0, 0, canvas.width, canvas.height);
                handles.forEach(function(handle){
                    context.beginPath();
                    context.arc(handle.x, handle.y, handle.radius, 0, 2 * Math.PI);
                    context.fill();
                });

                var upperDist = dist(handles[0], handles[1]);
                var upperDir = {x: (handles[1].x - handles[0].x) / upperDist, y: (handles[1].y - handles[0].y) / upperDist};

                var lowerDist = dist(handles[3], handles[2]);
                var lowerDir = {x: (handles[2].x - handles[3].x) / lowerDist, y: (handles[2].y - handles[3].y) / lowerDist};

                var leftDist = dist(handles[0], handles[3]);
                var leftDir = {x: (handles[3].x - handles[0].x) / leftDist, y: (handles[3].y - handles[0].y) / leftDist};

                var rightDist = dist(handles[1], handles[2]);
                var rightDir = {x: (handles[2].x - handles[1].x) / rightDist, y: (handles[2].y - handles[1].y) / rightDist};

                // draw the horizontal grid lines
                verticalRatios.forEach(function (percentage){
                    var fromX = handles[0].x + upperDir.x * upperDist * percentage;
                    var fromY = handles[0].y + upperDir.y * upperDist * percentage;
                    var toX = handles[3].x + lowerDir.x * lowerDist * percentage;
                    var toY = handles[3].y + lowerDir.y * lowerDist * percentage;
                    context.beginPath();
                    context.moveTo(fromX, fromY);
                    context.lineTo(toX, toY);
                    context.stroke();
                });

                horizontalRatios.forEach(function(percentage){
                    var fromX = handles[0].x + leftDir.x * leftDist * percentage;
                    var fromY = handles[0].y + leftDir.y * leftDist * percentage;
                    var toX = handles[1].x + rightDir.x * rightDist * percentage;
                    var toY = handles[1].y + rightDir.y * rightDist * percentage;
                    context.beginPath();
                    context.moveTo(fromX, fromY);
                    context.lineTo(toX, toY);
                    context.stroke();
                });

                // draw outer box
                context.beginPath();
                context.moveTo(handles[handles.length-1].x, handles[handles.length-1].y);
                handles.forEach(function(handle){
                    context.lineTo(handle.x, handle.y);
                });
                context.stroke();

                window.requestAnimationFrame(step);
            }

            function dist(a ,b) {
                return Math.sqrt( (a.x-b.x)*(a.x-b.x) + (a.y-b.y)*(a.y-b.y) );
            }

            function readPage() {
                var xhr = new XMLHttpRequest();
                var path = '../doc/' + page.id + '/coordinates';
                var coordinates = handles.map((handle)=>{
                    return {x: handle.x / canvas.width,
                            y: handle.y / canvas.height};
                });
                var json = JSON.stringify(coordinates);

                console.log(json);
                xhr.open('POST', path, true);
                xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xhr.onload = function(e) {
                    location.reload();
                };
                xhr.send(json);
            }
        </script>

    div
        style.
            table {
                border-spacing: 0px;
                border-collapse: collapse;
            }
        table(border="1")
            tr
                td square
                td Y
                td N
                td R
                td A
                td M
            each square in page.votes.squares
                tr
                    td #{square.id}
                    td
                        input(type="radio", name="vote-#{square.id}", value="0", checked=square.vote=="yes")
                    td
                        input(type="radio", name="vote-#{square.id}", value="0", checked=square.vote=="no")
                    td
                        input(type="radio", name="vote-#{square.id}", value="0", checked=square.vote=="refrain")
                    td
                        input(type="radio", name="vote-#{square.id}", value="0", checked=square.vote=="absent")
                    td
                        input(type="radio", name="vote-#{square.id}", value="0", checked=square.vote=="missing")
